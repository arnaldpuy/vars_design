---
title: "VARS in R"
author: "Arnald Puy"
header-includes:
  - \usepackage[font=footnotesize]{caption}
  - \usepackage{dirtytalk}
  - \usepackage{booktabs}
  - \usepackage{tabulary}
  - \usepackage{enumitem}
  - \usepackage{lmodern}
  - \usepackage[T1]{fontenc}
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: no
    toc_depth: 2
    keep_tex: true
  word_document:
    toc: no
    toc_depth: '2'
  html_document:
    keep_md: true
link-citations: yes
fontsize: 11pt
bibliography: /Users/arnald/Documents/bibtex/LATEX_density.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage

```{r preliminary steps, results="hide", message=FALSE, warning=FALSE}

# PRELIMINARY FUNCTIONS -------------------------------------------------------

# Function to read in all required packages in one go:
loadPackages <- function(x) {
  for(i in x) {
    if(!require(i, character.only = TRUE)) {
      install.packages(i, dependencies = TRUE)
      library(i, character.only = TRUE)
    }
  }
}

# Install development version of sensobol
remotes::install_github("arnaldpuy/sensobol")

# Load the packages
loadPackages(c("tidyverse", "sensobol"))



# Create custom theme
theme_AP <- function() {
  theme_bw() +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.background = element_rect(fill = "transparent",
                                           color = NA),
          legend.key = element_rect(fill = "transparent",
                                    color = NA))
}

# Set checkpoint

dir.create(".checkpoint")
library("checkpoint")

checkpoint("2020-03-09", 
           R.version ="3.6.1", 
           checkpointLocation = getwd())
```

\newpage

```{r star_function, cache=TRUE}

# FUNCTION TO CREATE STAR-VARS ------------------------------------------------

vars_matrices <- function(N, params, h) {
  out <- center <- sections <- A <- B <- AB <- X <- out <- list()
  mat <- randtoolbox::sobol(n = N, dim = length(params))
  for(i in 1:nrow(mat)) {
    center[[i]] <- mat[i, ]
    sections[[i]] <- sapply(center[[i]], function(x) {
      all <- seq(x %% h, 1, h)
      non.zeros <- all[all!= 0] # Remove zeroes
      })
    B[[i]] <- sapply(1:ncol(mat), function(x) 
      sections[[i]][, x][!sections[[i]][, x] %in% center[[i]][x]])
    A[[i]] <- matrix(center[[i]], nrow = nrow(B[[i]]), ncol = length(center[[i]]), byrow = TRUE)
    X[[i]] <- rbind(A[[i]], B[[i]])
    for(j in 1:ncol(A[[i]])) {
      AB[[i]] <- A[[i]]
      AB[[i]][, j] <- B[[i]][, j]
      X[[i]] <- rbind(X[[i]], AB[[i]])
    }
    AB[[i]] <- X[[i]][(2 * nrow(B[[i]]) + 1):nrow(X[[i]]), ]
    out[[i]] <- rbind(unname(center[[i]]), AB[[i]])
  }
  return(do.call(rbind, out))
}

# Function to cut by size
CutBySize <- function(m, block.size, nb = ceiling(m / block.size)) {
  int <- m / nb
  upper <- round(1:nb * int)
  lower <- c(1, upper[-nb] + 1)
  size <- c(upper[1], diff(upper))
  cbind(lower, upper, size)
}

# Function to compute VARS-TI
vars_ti <- function(Y, N, params, h) {
  n.cross.points <- length(params) * ((1 / h) - 1) + 1
  index.centers <- seq(1, length(Y), n.cross.points)
  mat <- matrix(Y[-index.centers], ncol = N)
  indices <- CutBySize(nrow(mat), nb = length(params))
  out <- list()
  for(i in 1:nrow(indices)) {
    out[[i]] <- mat[indices[i, "lower"]:indices[i, "upper"], ]
  }
  d <- lapply(1:length(params), function(x) 
    lapply(1:ncol(out[[x]]), function(j) {
      da <- c(out[[x]][, j][1], 
              rep(out[[x]][, j][-c(1, length(out[[x]][, j]))], each = 2), 
              out[[x]][, j][length(out[[x]][, j])])
    }))
  out <- lapply(d, function(x) lapply(x, function(y) matrix(y, nrow = length(y) / 2, byrow = TRUE)))
  variogr <- unlist(lapply(out, function(x)
    lapply(x, function(y) 1 / 2 * mean(y[, 1] - y[, 2]) ^ 2)) %>%
      lapply(., function(x) Rfast::colmeans(do.call(rbind, x))))
  covariogr <- unlist(lapply(out, function(x)
    lapply(x, function(y) cov(y[, 1], y[, 2]))) %>%
      lapply(., function(x) Rfast::colmeans(do.call(rbind, x))))
  VY <- var(Y[index.centers])
  output <- (variogr + covariogr) / VY
  return(output)
}
```

```{r settings}

# DEFINE THE SETTINGS FOR A STAR-VARS SAMPLE MATRIX ---------------------------

N <- 200 # Star centers
h <- 0.1 # h step
```

```{r ishi, cache=TRUE, dependson=c("star", "settings")}

# VARS-TO FOR THE ISHIGAMI FUNCTION -------------------------------------------

params <- paste("X", 1:3, sep = "")
mat <- vars_matrices(N = N, params = params, h = h)
Y <- sensobol::ishigami_Fun(mat)
output <- vars_ti(Y = Y, N = N, params = params, h = h)
print(round(output, 3))
```

```{r sobolG, cache=TRUE, dependson = c("star", "settings")}

# VARS-TO FOR THE SOBOL' G FUNCTION -------------------------------------------

params <- paste("X", 1:8, sep = "")
mat <- vars_matrices(N = N, params = params, h = h)
Y <- sensobol::sobol_Fun(mat)
output <- vars_ti(Y = Y, N = N, params = params, h = h)
print(round(output, 3))
```

```{r morris, cache=TRUE, dependson = c("star", "settings")}

# VARS-TO FOR THE MORRIS FUNCTION -------------------------------------------

params <- paste("X", 1:20, sep = "")
mat <- vars_matrices(N = N, params = params, h = h)
Y <- sensitivity::morris.fun(mat)
output <- vars_ti(Y = Y, N = N, params = params, h = h)
print(round(output, 3))
```
